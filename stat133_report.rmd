---
title: "Analysis of UC Compensation Data, 2012-2014"
author: "Angela Dai, Abizer Lokhandwala, Michael Jetsupphasuk, Harry Sutcliffe"
output: pdf_document
---

```{r, echo = FALSE, eval = TRUE, warning=F, message=F}
library(readr)
library(ggplot2)
library(dplyr)
library(stringr)
library(hash)
library(reshape2)
library(scales)
```

# Introduction
In 2014, the largest database of California government employee compensation was released: Transparent California. It is searchable by name and job titles on TransparentCalifornia.com and includes over 2 million salary records. Being University of California (UC) students, we will investigate UC employee compensation data. With tuition and student debt at all-time highs, university spending is under scrutiny. Since the delivery of education, research, and health care is labor intensive, payroll costs account for about half of the UC's annual operating budget. Thus, we thought it would be both interesting and important to analyze this data. 

## Description of Problems
Our main research question is: How has the University of California pay distribution changed over time? To answer this, we will answer these questions: What are the disparities between academic vs. non-academic pay over time? How much does the average lecturer/professor/etc (academic positions only) make? What does the distribution of pay look like? How has total staff grown in relation to enrollment?

## Description of Data
Our three primary raw data sources were from TransparentCalifornia.com for 2012, 2013, and 2014 UC compensation data. Each of the data sets had over 260,000 lines of information covering employee name, job title, base pay, overtime pay, total benefits, total pay, total pay with benefits, year, and agency. While the availability of this information online was intended to show "transparency and public accountability," the format of the data hindered analysis since it was incredibly inconsistent within and between years. To help navigate the title coding system, we used the UCOP Academic Title Code document. 

### Set-up
Set-up for this analysis was nontrivial due to the sheer amount of variation in the underlying dataset. For example, in one year, the employee names were capitalized, whereas in the others, they were not, and in another year, names were in the form of "fname lname" but in the other years they were in the form of "lname, fname." In one year's data, the titles contained full words - e.g. "PROFESSOR-HCOMP," while the other years used abbreviated title names such as "PROF-HCOMP." Also, the raw data files were not properly encoded in some cases - the Title dataset, for example, had strange Unicode characters in a number of titles which we could not correct for in R itself. The Title dataset also had another major problem: in some cases, the words in the titles where separated by a space and/or a hyphen, with no consistency in style, but in the yearly compensation CSVs, the words were separated with different delimiters or number of delimiters, such as two (or more) spaces/hyphens instead of one, or spaces/hyphens switched in with respect to their locations in the Title dataset, and several other tedious problems like this. Cleaning the data was a major hassle and frustration. Data inconsistency handicapped the confidence with which we were able to make any analyses on the dataset at large.

With regards to cleaning, R's tools where unfortunately insufficient for our purposes. We had to resort to command like utilities (cut, sort, sed) and manual munging in a text editor (for cleaning up Unicode, figuring out the permutations of spaces and hyphens necessary to match all the cases we had the patience to find) in order to get a dataset R (and our group) was happy with. Nonetheless, some of R's tools where far superior to any external ones, especially with respect to transforming CSVs - write.csv in particular generates beautiful output that lends itself very well to replicability. 

We begin by loading the data as downloaded from the Transparent California website:
```{r, echo = F, eval = T, warning = F, message = F}
setwd('rawdata')

uctca_colnames <- c("Name", "Title", "Base", "Overtime", "Other", "Benefits", "Subtotal", "Total", "Year", "Notes", "Agency")

uc2011 <- read_csv("university-of-california-2011.csv", col_names = uctca_colnames, skip = 1) %>% filter(Total > 1000)
uc2012 <- read_csv("university-of-california-2012.csv", col_names = uctca_colnames, skip = 1) %>% filter(Total > 1000)
uc2013 <- read_csv("university-of-california-2013.csv", col_names = uctca_colnames, skip = 1) %>% filter(Total > 1000)
uc2014 <- read_csv("university-of-california-2014.csv", col_names = uctca_colnames, skip = 1) %>% filter(Total > 1000)
```
We do an initial filter to only get employees with a total compensation of > $1,000 in order to slightly simplify the analysis.

General housekeeping:
```{r, echo = F, eval = T}
attributes(uc2013)$problems <- NULL
attributes(uc2014)$problems <- NULL
```

Prior to finding the UC Titles dataset, we tried manually grouping the ~2900 unique titles in the datasets via regex. We set up a hash with associated titles in order to `sapply()` a regex across the list of titles to get them matched to groups.

Using this method, we eventually tagged about 91.5% of the ~250,000 employees in the dataset with a department. However, this method was problematic, as it did not lend itself well to separating employees that fell into multiple categories, such as assistant/associate/visiting/research professors, and still left us with a large number of departments to group further. The code to make this work was also long, slow, and complicated, so we abandoned this thread.

We then found and began cleaning the Title dataset by copy-pasting the table from a PDF provided by the UCOP website into Microsoft Excel and using Excel's CSV output tools to generate a initial, raw CSV datafile. We then read this data into R to begin exploratory analysis. This was a deadend, as we had to use `grep()` and regular expressions to manually correct individual problems in the CSV, and this was ugly, confusing and difficult to maintain. So, we instead used dplyr to extract and sort the columns we wanted and used `write.csv()` to generate a second-stage CSV, which we then piped through a text editor, where we manually made corrections and then used this final CSV as the basis for the rest of our analysis. This was an improvement over our previous attempt, in that it gave us an easy way to separate academic from staff/non-academic titles, but it was not as granular as our manual, regular-expressions based attempt. Nonetheless, it was the schema we went with for our analysis.

We are defining the classification as follows:

* Academic employees: those directly engaged in the academic mission - professors, clinical professors, other teaching faculty, researchers, and other academic titles
* Staff/non-academic employees: those who support academic departments, student services, patient care and other university functions


```{r, echo = F, eval = T}
setwd('rawdata')
titles <- read.csv('academic-titles.csv', strip.white = T, stringsAsFactors = F)

uc2011 <- left_join(uc2011, titles, by = 'Title') %>% mutate(Academic = !is.na(Category))
uc2012 <- left_join(uc2012, titles, by = 'Title') %>% mutate(Academic = !is.na(Category))
uc2013 <- left_join(uc2013, titles, by = 'Title') %>% mutate(Academic = !is.na(Category))
uc2014 <- left_join(uc2014, titles, by = 'Title') %>% mutate(Academic = !is.na(Category))

academic_by_department <- function(df) {
  df %>% filter(Academic == TRUE) %>%
    group_by(Category) %>%
      summarize(avg = mean(Total),
                n = n()) %>%
        mutate(Category = reorder(Category, avg))
}

uc2011.by_department <- academic_by_department(uc2011)
uc2012.by_department <- academic_by_department(uc2012)
uc2013.by_department <- academic_by_department(uc2013)
uc2014.by_department <- academic_by_department(uc2014)
```

*Other Resources:* 
* Desrochers, D. M., & Kirshstein, R. J. (2014). Labor intensive or labor expensive? Changing staffing and compensation patterns in higher education (Issue Brief). Washington, DC: American Institutes for Research.
* UC Student Enrollment

# Analysis Approach
## Pie chart of Distribution of Total Compensation - executive pay, academic, health centers
```{r, echo = F, eval = T}



```

## Academic vs. Staff/Non-Academic Workforce Distribution of Total Compensation, 2012-2014
```{r, echo = F, eval = T}
across_years <- data.frame(
  'Year' = c(2012, 2013, 2014),
  'Academic' = c(sum(uc2012[which(uc2012$Academic == TRUE), 'Total']),
                 sum(uc2013[which(uc2013$Academic == TRUE), 'Total']),
                 sum(uc2014[which(uc2014$Academic == TRUE), 'Total'])),
  
  'Nonacademic' = c(sum(uc2012[which(uc2012$Academic == FALSE), 'Total']),
                    sum(uc2013[which(uc2013$Academic == FALSE), 'Total']),
                    sum(uc2014[which(uc2014$Academic == FALSE), 'Total']))
)

across_years <- across_years %>% 
  mutate(Difference = Nonacademic - Academic,
         Total = Academic + Nonacademic)

gp <- ggplot(melt(across_years[, c('Nonacademic', 'Academic', 'Year')], 
                  id.vars = 'Year', value.name = 'Amount'), 
             aes(x = Year, y = Amount)) + 
  geom_bar(aes(fill = variable), stat = 'identity', position = 'fill') + 
  scale_y_continuous(labels = percent_format()) + 
  labs(fill = "", 
       title = 'Academic vs. Nonacademic Spending')

# Acad/Nonacad amounts
gp <- gp + geom_text(aes(label = paste0('$', format(Amount, big.mark = ',')), 
                         y = 0.4, ymax = 1), 
                     position = 'stack', size = rel(3), color = 'azure', fontface = 'bold')
# total amt
gp <- gp + geom_text(data = across_years, 
                     aes(label = paste0('$', format(Total, big.mark = ',')), 
                         y = 0.2,
                         x = Year), 
                     size = rel(3.5), 
                     color = 'white', 
                     fontface = 'bold', 
                     position = 'stack') +
  theme(legend.position = 'bottom', plot.title = element_text(size = rel(2))) 
# amt diff
gp <- gp + geom_text(data = across_years,
                     aes(label = paste0('-$', format(Difference, big.mark = ',')),
                         y = 0.15,
                         x = Year),
                     position = 'stack',
                     color = 'yellow', 
                     size = rel(2))

```
```{r, fig.height = 4, fig.width = 7}
gp
```
This could be a bar chart showing changes in breakdown of academic vs staff/non-academic % compensation and changes in overall compensation, with: 
x-axis: $30k groupings of total compensation
y-axis: # of employees
We could conclude: 
The largest % of academic employees fall in the $x-$x range

##Average Total Compensation for Academic Positions, 2012-2014
```{r, echo = FALSE}
compare_between_titles.plot <- function(df, filter_df = TRUE) {
  if (filter_df)
  {
    dfn <- df %>% filter(avg > 40000 & n > 2)
  } else {
    dfn <- df
  }
  # fix from https://stackoverflow.com/questions/5106782/use-of-ggplot-within-another-function-in-r
  plot_to_return <- ggplot(dfn, aes(x = Category, y = avg), environment = environment()) + 
                      geom_bar(stat = 'identity') + 
                      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1)) +
                                                                # get the first index for which avg > (1,2,3)00k
                    geom_vline(xintercept = sapply(c(1, 2, 3) * 1e5, function(x) which(sort(dfn$avg) > x)[1])) +
                    geom_text(aes(label = dfn$n), angle = 90, hjust = 1) +
                    theme(axis.text.x = element_text(size = rel(0.5)))
  return(plot_to_return)
}

# get a dataframe merging across all three years

uc12_14 <- rbind(uc2012.by_department, uc2013.by_department, uc2014.by_department) %>%
  group_by(Category) %>% 
    summarize(avg = mean(avg),
              n = floor(mean(n))) %>%
      mutate(Category = reorder(Category, avg))
  

uc12_14.plot <- compare_between_titles.plot(uc12_14, TRUE)

uc2011.by_department.plot <- compare_between_titles.plot(uc2011.by_department, FALSE)
uc2012.by_department.plot <- compare_between_titles.plot(uc2012.by_department, TRUE)
uc2013.by_department.plot <- compare_between_titles.plot(uc2013.by_department, TRUE)
uc2014.by_department.plot <- compare_between_titles.plot(uc2014.by_department, TRUE)
```

```{r, fig.height = 4, fig.width = 7}
uc2012.by_department.plot
uc2013.by_department.plot
uc2014.by_department.plot

uc12_14.plot
```


Conclude: the average pay of academic employees has been increasing/decreasing

##Workforce Headcount vs. Total Compensation Trends, 2012-2014
```{r, echo=FALSE}


```
Hypothesize that as headcount rises, compensation expected to rise. Is this tied to changes in student enrollment?

##Components of Total Compensation for Academic vs Staff
```{r, echo=FALSE}


```
Hypothesize more benefits for academic positions? E.g. they may have the same salary, but total compensation differs because of benefits.

##Student Services Compensation vs. UC Student Enrollment, 2012-2014

```{r, echo=FALSE}


```
Differences in % changes 
How many student services staff per 1,000 students
How much has student services compensation changed per 1,000 students

##Workforce Headcount vs. UC Student Enrollment, 2012-2014
```{r, echo=FALSE, fig.width=7, fig.height=4}
#source for enrollment can be found in resources folder as enrollment-data.pdf

#this function finds the percent increase per year for 2012-14
#takes in a numeric vector with three entries
#will output a vector with three entries for percent increases for 2012-13 and 2013-14
#first entry will be zero as a baseline and to show increase between 2012-13 in a plot
find_percent <- function(totals){
  diff = c(totals[2] - totals[1], totals[3] - totals[2])
  percents = diff / totals[1:2]
  percents = c(0, percents)
  return(percents)
}

uc2012.academic <- uc2012 %>% filter(Academic == TRUE) %>% select(-Academic)
uc2013.academic <- uc2013 %>% filter(Academic == TRUE) %>% select(-Academic)
uc2014.academic <- uc2014 %>% filter(Academic == TRUE) %>% select(-Academic)
uc2012.nonacademic <- uc2012 %>% filter(Academic == FALSE) %>% select(-Academic)
uc2013.nonacademic <- uc2013 %>% filter(Academic == FALSE) %>% select(-Academic)
uc2014.nonacademic <- uc2014 %>% filter(Academic == FALSE) %>% select(-Academic)

enroll = c(184562, 183498, 191369)
tot.acad = c(nrow(uc2012.academic), nrow(uc2013.academic), nrow(uc2014.academic))
tot.non = c(nrow(uc2012.nonacademic), nrow(uc2013.nonacademic), nrow(uc2014.nonacademic))

percent.enroll = find_percent(enroll)
percent.acad = find_percent(tot.acad)
percent.non = find_percent(tot.non)

df.perc = data.frame(enroll = percent.enroll, acad = percent.acad, 
                     non = percent.non, total = percent.acad+percent.non, 
                     year = c(2012:2014), row.names = NULL)


#graphing percent increase in enrollment vs. # of faculty/staff/admin
ggplot(data = df.perc, aes(year)) +
  geom_point(aes(y = acad, color = 'Academic')) +
  geom_point(aes(y = non, color = 'Non-Academic')) +
  geom_point(aes(y = total, color = 'Total')) +
  geom_point(aes(y = enroll, color = 'Enrollment')) +
  geom_line(aes(y = acad, color = 'Academic')) +
  geom_line(aes(y = non, color = 'Non-Academic')) +
  geom_line(aes(y = total, color = 'Total')) +
  geom_line(aes(y = enroll, color = 'Enrollment')) +
  ggtitle('Percent Increase in Enrollment Compared to Faculty/Staff (2012-14)') +
  xlab('Year') +
  ylab('Percent') +
  scale_color_discrete(name = 'Legend')
```
Hypothesize more headcount with more enrollment

##Workforce Compensation vs. UC Student Enrollment, 2012-2014
```{r, echo=FALSE}

```
Hypothesize more compensation with more enrollment. Since academic pay has decreased from 2013-2014, how are costs being contained? See next graph

##Changes in % Lecturers vs % Tenured Professors 

```{r, echo=FALSE}

```
Are lecturers replacing full-time professors (or vice versa) in effort to contain costs? 


##Changes in Tuition vs Academic Spending
```{r, echo=FALSE}

```
It is often perceived that faculty spending is driving tuition increases. Is tuition increasing at the same rate as academic spending?


##Total Compensation by Acad/Non-Acad over Time
```{r, echo=FALSE, fig.width=7, fig.height=4}
#Total Overhead over Time
ggplot(data = across_years, aes(Year)) +
  geom_point(aes(y = Academic, color = 'acad')) +
  geom_point(aes(y = Nonacademic, color = 'non')) +
  geom_line(aes(y = Academic, color = 'acad')) +
  geom_line(aes(y = Nonacademic, color = 'non')) +
  ggtitle('Total Overhead by Academic and Non-Academic (2012-14)') +
  xlab('Year') +
  ylab('Total')
```
```{r, echo=FALSE, fig.width=7, fig.height=4}

#Difference in Overhead
ggplot(data = across_years, aes(Year)) +
  geom_point(aes(y = Difference, color = 'dif')) +
  geom_line(aes(y = Difference, color = 'dif')) +
  ggtitle('Difference between Academic and Non-Academic Total Overhead (2012-14)') +
  xlab('Year') +
  ylab('Difference')
```
```{r, echo=FALSE, fig.width=7, fig.height=4}

#Two graphs above combined
ggplot(data = across_years, aes(Year)) +
  geom_point(aes(y = Academic, color = 'acad')) +
  geom_point(aes(y = Nonacademic, color = 'non')) +
  geom_point(aes(y = Difference, color = 'dif')) +
  geom_line(aes(y = Academic, color = 'acad')) +
  geom_line(aes(y = Nonacademic, color = 'non')) +
  geom_line(aes(y = Difference, color = 'dif')) +
  ggtitle('Total Overhead by Academic and Non-Academic (2012-14)') +
  xlab('Year') +
  ylab('Total/Difference (in USD)')

```


##Comparing Compensation for Three Types of Professor

```{r, echo=FALSE, fig.width=7, fig.height=4}

#Densities of Total Pay by Type of Professor
tenure.prof = uc2014.academic$Total[uc2014.academic$Category == 'PROFESSORIAL-TENURE']
clin.series =  uc2014.academic$Total[uc2014.academic$Category == "PROFESSOR OF CLINICAL"]
health.sciences = uc2014.academic$Total[uc2014.academic$Category == 'HEALTH SCIENCES CLINICAL PROFESSOR']
dft = data.frame(tenure = tenure.prof)
dfc = data.frame(clinical = clin.series)
dfh = data.frame(health = health.sciences)

ggplot() +
  geom_density(data = dft, aes(x = tenure, fill = 'tenure'), alpha = 0.7) + 
  geom_density(data = dfc, aes(x = clinical, fill = 'clinical'), alpha = 0.7) +
  geom_density(data = dfh, aes(x = health, fill = 'health'), alpha = 0.7) +
  scale_fill_discrete(name = 'Type of Professor', labels = c('Clinical', 'Health Sciences Clinical', 'Tenured')) +
  ggtitle('Densities of Total Pay by Type of Professor') +
  xlab('Total') +
  ylab('Density')

```
